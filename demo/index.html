<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=0"/>
  <title>editor</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: arial, sans-serif;
      background: #FFF;
    }

    .wrap {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .menu {
      display: flex;
      align-items: center;
      box-sizing: border-box;
      padding: 0 20px;
      height: 50px;
      min-height: 50px;
      background: #413B3D;
    }

    .container {
      flex: 1;
      display: flex;
    }

    .list {
      width: 250px;
      background: #EEE8EA;
    }

    .page {
      border-bottom: 1px solid #CCC;
      height: 150px;
      overflow-y: scroll;
    }

    .tree {
      margin: 0;
      padding: 5px 10px;
      box-sizing: border-box;
      min-height: 100%;
      list-style: none;
      overflow-y: scroll;
      font-size: 14px;
    }

    .tree li {
      display: flex;
      align-items: center;
      padding: 2px 0;
    }

    .tree .type {
      width: 16px;
      font-family: Menlo, "Courier New";
      font-size: 12px;
      color: #999;
      cursor: default;
      user-select: none;
    }

    .tree .name {
      flex: 1;
    }

    .tree .visible {
      font-size: 12px;
      color: #999;
      cursor: default;
      user-select: none;
    }

    .tree li:hover .visible {
      color: #F99;
    }

    .main {
      flex: 1;
      position: relative;
    }

    .side {
      width: 300px;
      background: #FFF;
      border-left: 1px solid #DDD;
    }

    .canvas-c {
      width: 100%;
      height: 100%;
      background: #F3F3F3;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .overlap {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
    }

    .overlap.space {
      cursor: grab;
    }
    .overlap.space.down {
      cursor: grabbing;
    }

    .hover {
      position: absolute;
      border: 1px solid #F43;
      visibility: hidden;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
      transform: translate(-1px, -1px);
    }

    .selection {
      position: absolute;
      visibility: hidden;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }

    .t {
      position: absolute;
      left: 0;
      top: -4px;
      width: 100%;
      height: 8px;
      transform: scaleY(0.5);
      cursor: ns-resize;
    }

    .t b {
      position: absolute;
      left: 0;
      top: 2px;
      width: 100%;
      height: 100%;
      border-top: 1px solid #34F;
    }

    .r {
      position: absolute;
      right: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      transform: scaleX(0.5);
      cursor: ew-resize;
    }

    .r b {
      position: absolute;
      right: 2px;
      top: 0;
      width: 100%;
      height: 100%;
      border-right: 1px solid #34F;
    }

    .b {
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 8px;
      transform: scaleY(0.5);
      cursor: ns-resize;
    }

    .b b {
      position: absolute;
      left: 0;
      bottom: 2px;
      width: 100%;
      height: 100%;
      border-bottom: 1px solid #34F;
    }

    .l {
      position: absolute;
      left: -4px;
      top: 0;
      width: 8px;
      height: 100%;
      transform: scaleX(0.5);
      cursor: ew-resize;
    }

    .l b {
      position: absolute;
      left: 2px;
      top: 0;
      width: 100%;
      height: 100%;
      border-left: 1px solid #34F;
    }

    .tl {
      position: absolute;
      left: 0;
      top: 0;
      width: 14px;
      height: 14px;
      border: 1px solid #999;
      background: #FFF;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      transform: translate(-8px, -8px) scale(0.5);
      cursor: nwse-resize;
    }

    .tr {
      position: absolute;
      right: 0;
      top: 0;
      width: 14px;
      height: 14px;
      border: 1px solid #999;
      background: #FFF;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      transform: translate(8px, -8px) scale(0.5);
      cursor: nesw-resize;
    }

    .br {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 14px;
      height: 14px;
      border: 1px solid #999;
      background: #FFF;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      transform: translate(8px, 8px) scale(0.5);
      cursor: nwse-resize;
    }

    .bl {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 14px;
      height: 14px;
      border: 1px solid #999;
      background: #FFF;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      transform: translate(-8px, 8px) scale(0.5);
      cursor: nesw-resize;
    }

    .show {
      visibility: visible;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="menu">
    <input type="file" id="file" accept=".sketch"/>
  </div>
  <div class="container">
    <div class="list">
      <div class="page" id="page"></div>
      <ol class="tree" id="tree"></ol>
    </div>
    <div class="main" id="main">
      <div class="canvas-c" id="canvasC"></div>
      <div class="overlap" id="overlap">
        <div class="hover" id="hover"></div>
        <div class="selection" id="selection">
          <div class="l" id="l"><b></b></div>
          <div class="t" id="t"><b></b></div>
          <div class="r" id="r"><b></b></div>
          <div class="b" id="b"><b></b></div>
          <div class="tl" id="tl"></div>
          <div class="tr" id="tr"></div>
          <div class="br" id="br"></div>
          <div class="bl" id="bl"></div>
        </div>
      </div>
    </div>
    <div class="side" id="side"></div>
  </div>
</div>
<script src="../index.js"></script>
<script>
  const input = document.querySelector('#file');
  const tree = document.querySelector('#tree');
  const main = document.querySelector('#main');
  const canvasC = document.querySelector('#canvasC');
  const overlap = document.querySelector('#overlap');
  const hover = document.querySelector('#hover');
  const selection = document.querySelector('#selection');

  matchMedia(
    `(resolution: ${window.devicePixelRatio}dppx)`
  ).addEventListener("change", function() {
  });

  let root;
  let originX, originY;
  let isDown, isMove;
  let startX, startY, lastX, lastY;
  let hoverNode, selectNode;
  let metaKey, shiftKey, ctrlKey, altKey, spaceKey;
  let dpi = window.devicePixelRatio;
  let curPage, pageTx, pageTy;
  let structs = [];

  input.onchange = function(e) {
    const file = input.files[0];
    input.value = null;
    input.blur();
    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    reader.onload = function() {
      editor.openAndConvertSketchBuffer(reader.result).then(function(json) {
        const canvas = document.createElement('canvas');

        function resize() {
          const { clientWidth, clientHeight } = canvasC;
          canvas.width = clientWidth * dpi;
          canvas.height = clientHeight * dpi;
          const o = canvasC.getBoundingClientRect();
          originX = o.left;
          originY = o.top;
          if (root) {
            root.updateStyle({
              width: clientWidth * dpi,
              height: clientHeight * dpi,
            });
          }
        }

        resize();
        window.onresize = resize;
        canvasC.appendChild(canvas);
        root = editor.parse(json, canvas, dpi);
        root.on('refresh', function(lv) {
          if (lv & editor.refresh.level.RefreshLevel.REBUILD) {
            let s = '';
            structs = root.getCurPageStructs();
            structs.forEach((item, i) => {
              const { node, lv } = item;
              let type = 'n', className = '';
              if (node.isArtBoard) {
                type = 'a';
                className = 'ab';
              }
              else if (node.isGroup) {
                type = 'g';
                className = 'group';
              }
              else if (node instanceof editor.node.Bitmap) {
                type = 'i';
                className = 'img';
              }
              const visible = node.computedStyle[editor.style.define.StyleKey.VISIBLE];
              s += `<li class="${className}" style="margin-left:${(lv - 3) * 16}px" index="${i}">
<span class="type">${type}.</span>
<span class="name">${node.props.name}</span>`;
              if (!node.isArtBoard) {
                s += `<span class="visible" visible="${visible}">${visible ? '可见' : '隐藏'}</span>`;
              }
              s += '</li>';
            });
            tree.innerHTML = s;
          }
        });
      });
    }
  }

  tree.addEventListener('click', e => {
    const target = e.target;
    if (target.classList.contains('visible')) {
      const visible = target.getAttribute('visible') === 'true';
      const index = parseInt(target.parentElement.getAttribute('index'));
      const node = structs[index].node;
      node.updateStyle({
        visible: !visible,
      });
      target.setAttribute('visible', (!visible).toString());
      target.innerHTML = visible ? '隐藏' : '可见';
    }
  });

  function showHover(node) {
    if (hoverNode !== node) {
      hoverNode = node;
      const rect = hoverNode.getBoundingClientRect();
      hover.style.left = rect.left / dpi + 'px';
      hover.style.top = rect.top / dpi + 'px';
      hover.style.width = (rect.right - rect.left) / dpi + 'px';
      hover.style.height = (rect.bottom - rect.top) / dpi + 'px';
      hover.classList.add('show');
    }
  }

  function hideHover() {
    if (hoverNode) {
      hoverNode = null;
      hover.classList.remove('show');
    }
  }

  function onMove(x, y) {
    lastX = x;
    lastY = y;
    const nx = x - originX;
    const ny = y - originY;
    const inRoot = nx >= 0 && ny >= 0 && nx <= root.width && ny <= root.width;
    if (inRoot) {
      if (spaceKey) {
        if (!curPage || !isDown) {
          return;
        }
        const dx = lastX - startX, dy = lastY - startY;
        curPage.updateStyle({
          translateX: pageTx + dx,
          translateY: pageTy + dy,
        });
      }
      else {
        // metaKey按下可以选择最深叶子节点，但排除Group
        const node = root.getNodeFromCurPage(nx * dpi, ny * dpi, !metaKey, false, metaKey ? undefined : 1);
        if(node && node !== selectNode) {
          showHover(node);
        }
        else {
          hideHover();
        }
      }
    }
  }

  window.onscroll = function() {
    const o = canvasC.getBoundingClientRect();
    originX = o.left;
    originY = o.top;
  };

  overlap.addEventListener('mousedown', function(e) {
    if (!root) {
      return;
    }
    // 左键
    if (e.button === 0) {
      isDown = true;
      startX = e.pageX;
      startY = e.pageY;
      // 空格按下移动画布
      if (spaceKey) {
        curPage = root.getCurPage();
        if (!curPage) {
          return;
        }
        const o = curPage.getComputedStyle();
        pageTx = o.translateX;
        pageTy = o.translateY;
        overlap.classList.add('down');
      }
      // 普通是选择
      else {
        const nx = startX - originX;
        const ny = startY - originY;
        const node = root.getNodeFromCurPage(nx * dpi, ny * dpi, !metaKey, false, metaKey ? undefined : 1);
        if (selectNode !== node) {
          selectNode = node;
          if (node) {
            const {
              translateX,
              translateY,
            } = selectNode.getComputedStyle();
            const rect = selectNode.getBoundingClientRect();
            selection.style.left = rect.left / dpi + 'px';
            selection.style.top = rect.top / dpi + 'px';
            selection.style.width = (rect.right - rect.left) / dpi + 'px';
            selection.style.height = (rect.bottom - rect.top) / dpi + 'px';
            selection.classList.add('show');
            if (hoverNode) {
              hoverNode = null;
              hover.classList.remove('show');
            }
          }
          else {
            selection.classList.remove('show');
          }
        }
      }
    }
  });

  document.addEventListener('mousemove', function(e) {
    if (!root) {
      return;
    }
    onMove(e.pageX, e.pageY);
  });

  document.addEventListener('mouseup', function(e) {
    if (!root) {
      return;
    }
    if (e.button === 0) {
      isDown = false;
      if(spaceKey) {
        overlap.classList.remove('down');
      }
    }
  });

  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    if (!root) {
      return;
    }
    if (selectNode) {
      selectNode = null;
      selection.classList.remove('show');
    }
  });

  document.addEventListener('keydown', function(e) {
    const m = metaKey;
    metaKey = e.metaKey;
    altKey = e.altKey;
    ctrlKey = e.ctrlKey;
    shiftKey = e.shiftKey;
    if (!root) {
      return;
    }
    if (m !== e.metaKey) {
      onMove(lastX, lastY);
    }
    if (e.keyCode === 32) {
      spaceKey = true;
      overlap.classList.add('space');
      if (hoverNode) {
        hoverNode = null;
        hover.classList.remove('show');
      }
    }
  });

  document.addEventListener('keyup', function(e) {
    const m = metaKey;
    metaKey = e.metaKey;
    altKey = e.altKey;
    ctrlKey = e.ctrlKey;
    shiftKey = e.shiftKey;
    if (!root) {
      return;
    }
    if (m !== e.metaKey) {
      onMove(lastX, lastY);
    }
    if (e.keyCode === 32) {
      spaceKey = false;
      overlap.classList.remove('space');
    }
  });

  document.addEventListener('wheel', function(e) {
    if (!root) {
      return;
    }
    curPage = root.getCurPage();
    if (!curPage) {
      return;
    }
    if(hoverNode) {
      hoverNode = null;
      hover.classList.remove('show');
    }
    // 按下时缩放
    if (metaKey) {
      let sc = 1;
      if(e.deltaY < 0) {
        if(e.deltaY < -200) {
          sc = 0.125;
        }
        else if(e.deltaY < -100) {
          sc = 0.25;
        }
        else if(e.deltaY < -50) {
          sc = 0.5;
        }
        else if(e.deltaY < -20) {
          sc = 0.75;
        }
        else {
          sc = 0.875;
        }
      }
      else if(e.deltaY > 0) {
        if(e.deltaY > 200) {
          sc = 2;
        }
        else if(e.deltaY > 100) {
          sc = 1.75;
        }
        else if(e.deltaY > 50) {
          sc = 1.5;
        }
        else if(e.deltaY > 20) {
          sc = 1.25;
        }
        else {
          sc = 1.125;
        }
      }
      const x = lastX - originX;
      const y = lastY - originY;
      const pt = {
        x: x * dpi,
        y: y * dpi,
      };
      const { translateX, translateY, scaleX } = curPage.getComputedStyle();
      const inverse = editor.math.matrix.inverse(curPage.matrixWorld);
      // 求出鼠标屏幕坐标在画布内相对page的坐标
      const pt1 = editor.math.matrix.calPoint(pt, inverse);
      let scale = scaleX * sc;
      if(scale > 10) {
        scale = 10;
      }
      else if(scale < 0.1) {
        scale = 0.1;
      }
      const newMatrix = editor.style.transform.calMatrix({
        translateX,
        translateY,
        scaleX: scale,
        scaleY: scale,
      });
      // 新缩放尺寸，位置不动，相对page坐标在新matrix下的坐标
      const pt2 = editor.math.matrix.calPoint(pt1, newMatrix);
      // 差值是需要调整的距离
      const dx = pt2.x - pt.x / dpi, dy = pt2.y - pt.y / dpi;
      curPage.updateStyle({
        translateX: translateX - dx,
        translateY: translateY - dy,
        scaleX: scale,
        scaleY: scale,
      });
    }
    // shift+滚轮是移动
    else {
      if (shiftKey) {
        let sc = 0;
        if(e.deltaX< 0) {
          if(e.deltaX < -200) {
            sc = 50;
          }
          else if(e.deltaX < -100) {
            sc = 40;
          }
          else if(e.deltaX < -50) {
            sc = 30;
          }
          else if(e.deltaX < -20) {
            sc = 20;
          }
          else {
            sc = 10;
          }
        }
        else if(e.deltaX > 0) {
          if(e.deltaX > 200) {
            sc = -50;
          }
          else if(e.deltaX > 100) {
            sc = -40;
          }
          else if(e.deltaX > 50) {
            sc = -30;
          }
          else if(e.deltaX > 20) {
            sc = -20;
          }
          else {
            sc = -10;
          }
        }
        const { translateX } = curPage.getComputedStyle();
        curPage.updateStyle({
          translateX: translateX + sc,
        });
      }
      else {
        let sc = 0;
        if(e.deltaY < 0) {
          if(e.deltaY < -200) {
            sc = 50;
          }
          else if(e.deltaY < -100) {
            sc = 40;
          }
          else if(e.deltaY < -50) {
            sc = 30;
          }
          else if(e.deltaY < -20) {
            sc = 20;
          }
          else {
            sc = 10;
          }
        }
        else if(e.deltaY > 0) {
          if(e.deltaY > 200) {
            sc = -50;
          }
          else if(e.deltaY > 100) {
            sc = -40;
          }
          else if(e.deltaY > 50) {
            sc = -30;
          }
          else if(e.deltaY > 20) {
            sc = -20;
          }
          else {
            sc = -10;
          }
        }
        const { translateY } = curPage.getComputedStyle();
        curPage.updateStyle({
          translateY: translateY + sc,
        });
      }
    }
  });
</script>
</body>
</html>
